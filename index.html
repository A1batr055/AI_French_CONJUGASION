<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI法语变位大师 · 多模型简洁版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body{
      font-family:'Segoe UI',system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background: radial-gradient(circle at 10% 0%,#ecfdf5 0,#e0f2fe 40%,#f9fafb 100%);
    }
    [v-cloak]{display:none;}
    .shake{animation:shake .5s;}
    @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}100%{transform:translateX(0)}}
    .loader{border:4px solid #f3f3f3;border-top:4px solid #10b981;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body class="text-gray-800 h-screen flex flex-col overflow-hidden">

<div id="app" v-cloak class="h-full flex flex-col">
  <!-- 顶部导航 -->
  <nav class="bg-white/80 backdrop-blur border-b border-emerald-50 text-gray-900 py-3 shadow-sm z-10">
    <div class="max-w-5xl mx-auto flex justify-between items-center px-3 md:px-0">
      <h1 class="text-base md:text-lg font-semibold tracking-tight flex items-center gap-2 text-emerald-700">
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-emerald-100 text-emerald-700">
          <i class="fas fa-brain text-sm"></i>
        </span>
        <span class="flex flex-col leading-snug">
          <span>AI Conjugaison</span>
          <span class="text-[11px] text-gray-400 font-normal hidden sm:block">多模型 · 法语变位助手</span>
        </span>
      </h1>
      <div class="text-xs md:text-sm flex gap-4 items-center">
        <button @click="currentView='settings'"
                :class="['pb-1 border-b-2 transition-colors',currentView==='settings'?'border-emerald-500 text-emerald-700 font-semibold':'border-transparent text-gray-400 hover:text-gray-700']">
          设置 & Key
        </button>
        <button @click="currentView='library'"
                :class="['pb-1 border-b-2 transition-colors',currentView==='library'?'border-emerald-500 text-emerald-700 font-semibold':'border-transparent text-gray-400 hover:text-gray-700']">
          词库
        </button>
        <button @click="currentView='practice'"
                :class="['pb-1 border-b-2 transition-colors',currentView==='practice'?'border-emerald-500 text-emerald-700 font-semibold':'border-transparent text-gray-400 hover:text-gray-700']">
          练习
        </button>
      </div>
    </div>
  </nav>

  <main class="flex-grow overflow-y-auto py-6 px-4">
    <div class="max-w-5xl mx-auto h-full relative">
      <!-- 全局 Loading -->
      <div v-if="loading" class="absolute inset-0 bg-white/70 backdrop-blur-sm z-50 flex flex-col items-center justify-center rounded-2xl">
        <div class="loader mb-4"></div>
        <p class="text-emerald-600 font-semibold animate-pulse tracking-wide text-sm">{{ loadingText }}</p>
      </div>

      <!-- 设置 -->
      <div v-if="currentView==='settings'"
           class="max-w-2xl mx-auto bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-emerald-50 mt-10 p-6 md:p-8 flex flex-col gap-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900 tracking-tight">系统设置</h2>
          <span class="text-[11px] uppercase tracking-[0.16em] text-gray-400">LLM Providers</span>
        </div>
        <p class="text-xs text-gray-500">Key 仅保存在你的浏览器。前端直连会暴露 Key，请自行评估风险。</p>

        <!-- Provider 选择 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1.5">提供商</label>
            <select v-model="llm.provider" class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
              <option value="openrouter">OpenRouter</option>
              <option value="openai">OpenAI (ChatGPT)</option>
              <option value="gemini">Google Gemini</option>
              <option value="deepseek">DeepSeek</option>
              <option value="custom">自定义（手动填 Base URL）</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-500 mb-1.5">模型 ID</label>
            <input v-model="llm.model" placeholder="如：openai/gpt-3.5-turbo / gemini-2.0-flash / deepseek-chat"
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
          </div>
          <div v-if="llm.provider==='custom'">
            <label class="block text-xs font-medium text-gray-500 mb-1.5">自定义 Base URL</label>
            <input v-model="llm.baseUrl" placeholder="https://example.com/v1/chat/completions"
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
          </div>
        </div>

        <!-- Keys -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2">
          <div v-if="['openrouter','custom'].includes(llm.provider)">
            <label class="block text-xs font-medium text-gray-500 mb-1.5">OpenRouter / 自定义 Key</label>
            <input type="password" v-model="llm.keys.openrouter" placeholder="填入 OpenRouter 或自定义服务的 Key"
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg-gray-50/80">
            <p class="text-[11px] text-gray-400 mt-2">
              申请：<a href="https://openrouter.ai/keys" target="_blank" class="text-emerald-600 underline underline-offset-2">OpenRouter API Keys</a>
            </p>
          </div>
          <div v-if="llm.provider==='openai'">
            <label class="block text-xs font-medium text-gray-500 mb-1.5">OpenAI API Key</label>
            <input type="password" v-model="llm.keys.openai" placeholder="sk-..."
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg-gray-50/80">
          </div>
          <div v-if="llm.provider==='gemini'">
            <label class="block text-xs font-medium text-gray-500 mb-1.5">Gemini API Key</label>
            <input type="password" v-model="llm.keys.gemini" placeholder="在此粘贴你的 Google API Key"
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg-gray-50/80">
            <p class="text-[11px] text-gray-400 mt-2">
              申请：<a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-emerald-600 underline underline-offset-2">Gemini API Key</a>
            </p>
          </div>
          <div v-if="llm.provider==='deepseek'">
            <label class="block text-xs font-medium text-gray-500 mb-1.5">DeepSeek API Key</label>
            <input type="password" v-model="llm.keys.deepseek" placeholder="ds-..."
                   class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg-gray-50/80">
          </div>
        </div>

        <button @click="saveSettings"
                class="mt-4 w-full bg-emerald-600 text-white py-2.5 rounded-xl hover:bg-emerald-700 text-sm font密 tracking-wide transition flex items-center justify-center gap-2">
          <i class="fas fa-save text-xs"></i><span>保存设置并进入词库</span>
        </button>
      </div>

      <!-- 词库（支持分组） -->
      <div v-if="currentView==='library'" class="max-w-4xl mx-auto flex flex-col gap-6">
        <!-- 分组管理 -->
        <div class="bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-emerald-50 p-4 md:p-5 mt-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1.5">当前分组</label>
              <select v-model="currentGroup"
                      class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
                <option v-for="g in groupNames" :key="g" :value="g">{{ g }} ({{ groups[g].length }})</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1.5">新建分组</label>
              <div class="flex gap-2">
                <input v-model="newGroupName" placeholder="如：不规则动词"
                       class="flex-1 text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg-gray-50/80">
                <button @click="addGroup" class="px-4 py-2.5 bg-gray-900 text-white rounded-xl text-sm font-medium hover:bg黑 transition">添加分组</button>
              </div>
            </div>
            <div class="text-right text-xs text-gray-500">
              <div>总词数：{{ allVerbs.length }}</div>
              <div class="mt-1">当前分组：{{ groups[currentGroup]?.length || 0 }}</div>
            </div>
          </div>
        </div>

        <!-- 词条添加 -->
        <div class="bg白/80 backdrop-blur rounded-2xl shadow-sm border border-emerald-50 p-4 md:p-5">
          <div class="flex items-baseline justify-between">
            <h2 class="text-lg font-semibold text-gray-900">分组词库 · {{ currentGroup }}</h2>
            <span class="text-[11px] text-gray-400">点击卡片查看变位，可移动到其它分组</span>
          </div>
          <div class="flex gap-2 mt-3">
            <input v-model="newVerb" @keyup.enter="addVerb" placeholder="输入动词（如：s'asseoir, peindre）"
                   class="flex-grow text-sm px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none bg灰-50/80">
            <button @click="addVerb" class="px-4 md:px-5 py-2.5 bg-gray-900 text白 rounded-xl text-sm font-medium hover:bg黑 transition whitespace-nowrap">
              添加到 {{ currentGroup }}
            </button>
          </div>
        </div>

        <!-- 词条列表（当前分组） -->
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-6">
          <div v-for="(v, idx) in groupVerbs" :key="v"
               class="bg白/70 backdrop-blur border border-gray-100 hover:border-emerald-200 p-3 rounded-2xl shadow-sm hover:shadow-md transition-all">
            <div class="flex items-center justify-between gap-2">
              <button class="flex-1 text-left" @click="showConjugationTable(v)">
                <span class="block font-semibold text-gray-800 text-sm truncate">{{ v }}</span>
              </button>
              <button @click="removeVerb(idx)" class="ml-2 text-gray-300 hover:text-red-500 transition">
                <i class="fas fa-trash text-xs"></i>
              </button>
            </div>
            <div class="mt-2">
              <label class="block text-[11px] text-gray-400 mb-1">移动到</label>
              <select @change="moveVerb(v, $event.target.value)"
                      class="w-full text-xs px-2 py-1.5 border border-gray-200 rounded-lg bg-gray-50/80">
                <option disabled selected value="">选择分组</option>
                <option v-for="g in groupNames" :key="g" :value="g" v-if="g!==currentGroup">{{ g }}</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- 练习 -->
      <div v-if="currentView==='practice'" class="max-w-3xl mx-auto h-full flex flex-col">
        <!-- 配置 -->
        <div v-if="!isPracticeActive" class="bg-white/80 backdrop-blur rounded-2xl shadow-sm border border-emerald-50 mt-10 p-6 md:p-8">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="text-xl font-semibold text-gray-900 tracking-tight">生成练习配置</h2>
              <p class="text-xs text-gray-500 mt-1">
                选择水平 → 练习时态 → 动词来源。每个动词固定出 6 题（六个人称），总题数 = 词数 × 6。
              </p>
            </div>
            <span class="hidden sm:inline-flex text-[11px] uppercase tracking-[0.2em] text-gray-400">Practice</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1.5">语言水平（CEFR）</label>
              <select v-model="settings.level"
                      class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
                <option v-for="l in ['A1','A2','B1','B2','C1','C2']" :value="l">{{ l }}</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1.5">练习时态</label>
              <select v-model="settings.tense"
                      class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
                <option value="Présent">Présent（现在时）</option>
                <option value="Passé Composé">Passé Composé（复合过去）</option>
                <option value="Imparfait">Imparfait（未完成过去）</option>
                <option value="Futur Simple">Futur Simple（简单将来）</option>
                <option value="Subjonctif Présent">Subjonctif Présent（虚拟式现在）</option>
                <option value="Conditionnel Présent">Conditionnel Présent（条件式现在）</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-medium text-gray-500 mb-1.5">题目来源</label>
              <div class="flex flex-col gap-2 text-sm">
                <label class="inline-flex items-center gap-2">
                  <input type="radio" v-model="settings.mode" value="group" class="accent-emerald-600">
                  <span>按分组</span>
                </label>
                <label class="inline-flex items-center gap-2">
                  <input type="radio" v-model="settings.mode" value="all" class="accent-emerald-600">
                  <span>全词库随机</span>
                </label>
              </div>
            </div>

            <div v-if="settings.mode==='group'">
              <label class="block text-xs font-medium text-gray-500 mb-1.5">选择分组</label>
              <select v-model="settings.groupName"
                      class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
                <option v-for="g in groupNames" :key="g" :value="g">{{ g }}（{{ groups[g].length }} 词）</option>
              </select>
              <p class="text-[11px] text-gray-400 mt-1">总题数 = 该分组词数 × 6</p>
            </div>

            <div v-if="settings.mode==='all'">
              <label class="block text-xs font-medium text-gray-500 mb-1.5">随机抽取动词数量</label>
              <input type="number" min="1" :max="allVerbs.length" v-model.number="settings.count"
                     class="w-full text-sm px-3 py-2.5 border border-gray-200 rounded-xl bg-gray-50/80 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-400 outline-none">
              <p class="text-[11px] text-gray-400 mt-1">总题数 = 数量 × 6</p>
            </div>
          </div>

          <button @click="startPracticeSession" :disabled="!activeApiKey"
                  class="w-full py-3 rounded-xl text-sm font-medium shadow-sm transition flex items-center justify-center gap-2"
                  :class="activeApiKey?'bg-emerald-600 text-white hover:bg-emerald-700':'bg-gray-200 text-gray-500 cursor-not-allowed'">
            <i class="fas fa-magic text-xs" v-if="activeApiKey"></i>
            <span>{{ activeApiKey?'生成题目（调用 AI）':'请先在“设置”中输入 API Key' }}</span>
          </button>
        </div>

        <!-- 练习卡片 -->
        <div v-else class="flex flex-col h-full justify中心 mt-6 mb-8">
          <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg border border-emerald-50 p-6 md:p-8 relative min-h-[360px] flex flex-col justify-between">
            <div class="flex justify-between text-xs text-gray-400 mb-6 border-b border-gray-100 pb-2">
              <span class="inline-flex items-center gap-2">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                <span>{{ settings.tense }} · {{ currentCard.person }} · {{ settings.level }}</span>
              </span>
              <span>题目 {{ currentIndex + 1 }} / {{ sessionCards.length }}</span>
            </div>

            <div class="text-center px-2">
              <div class="text-2xl md:text-3xl font-semibold text-emerald-800 mb-1 tracking-tight">{{ currentCard.verb }}</div>
              <div class="text-xs text-gray-500 mb-6">请填写空格中的正确变位形式</div>

              <div class="text-lg md:text-xl leading-relaxed mb-6 font-medium text-gray-800">
                <span v-html="currentCard.prefix"></span>
                <input ref="answerInput" v-model="userInput" @keyup.enter="checkAnswer"
                       :class="{
                         'border-red-500 bg-red-50 text-red-600 shake': feedback.status==='wrong',
                         'border-emerald-500 bg-emerald-50 text-emerald-700': feedback.status==='correct',
                         'border-gray-300 bg-gray-50/80': feedback.status==='neutral'
                       }"
                       class="border-b-2 outline-none text-center mx-1 w-40 px-1 font-mono font-semibold bg-transparent transition-all text-base md:text-lg py-0.5"
                       autocomplete="off">
                <span v-html="currentCard.suffix"></span>
              </div>

              <div class="inline-flex items-center gap-2 text-gray-500 italic text-[13px] mt-2 bg-gray-50/80 px-3 py-2 rounded-full">
                <i class="fas fa-language text-xs text-gray-400"></i><span>"{{ currentCard.translation }}"</span>
              </div>
            </div>

            <div class="mt-6 h-14 text-center flex flex-col items-center justify-center gap-1">
              <div v-if="feedback.status==='wrong'" class="text-red-500 text-sm flex items-center gap-2"><i class="fas fa-times-circle text-sm"></i><span>不对，再想想。剩余机会：{{ 3 - feedback.attempts }}</span></div>
              <div v-if="feedback.showAnswer" class="text-orange-600 text-sm">正确答案：<span class="font-semibold">{{ currentCard.answer }}</span></div>
              <div v-if="feedback.status==='correct'" class="text-emerald-500 font-semibold text-base flex items-center gap-2"><i class="fas fa-check-circle text-lg"></i><span>Très bien !</span></div>
            </div>

            <div class="mt-4 flex flex-col sm:flex-row gap-3">
              <button v-if="feedback.status!=='correct'" @click="checkAnswer"
                      class="flex-1 bg-gray-900 text-white py-2.5 rounded-xl shadow-sm hover:bg-black text-sm font-medium transition">提交答案</button>
              <button v-else class="flex-1 bg-emerald-500 text-white py-2.5 rounded-xl text-sm font-medium cursor-wait opacity-80 flex items-center justify-center gap-2">
                <span class="w-3 h-3 border-2 border-white/40 border-t-white rounded-full animate-spin"></span><span>加载下一题...</span>
              </button>
              <button @click="endPractice"
                      class="sm:w-28 py-2.5 rounded-xl border border-gray-200 text-xs text-gray-500 hover:border-gray-300 hover:bg-gray-50 flex items-center justify-center gap-1 transition">
                <i class="fas fa-xmark text-xs"></i><span>结束练习</span>
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- 变位表模态框 -->
  <div v-if="showModal" class="固定 inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center p-4 z-50" @click.self="showModal=false">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-100">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/80 rounded-t-2xl">
        <div class="flex flex-col">
          <h3 class="text-lg font-semibold text-gray-900">变位表 · {{ modalVerb }}</h3>
          <span class="text-[11px] text-gray-400 mt-0.5">Présent / Passé Composé / Imparfait / Futur Simple / Subjonctif Présent / Conditionnel Présent</span>
        </div>
        <button @click="showModal=false" class="text-gray-400 hover:text-gray-700 transition"><i class="fas fa-times text-sm"></i></button>
      </div>
      <div class="p-4 md:p-6 overflow-y-auto prose max-w-none text-sm" v-html="modalContent"></div>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data(){
    const defaultLLM = {
      provider:'openrouter',
      model:'openai/gpt-3.5-turbo',
      baseUrl:'',
      keys:{ openrouter:'', openai:'', gemini:'', deepseek:'' }
    };
    let storedLLM = null;
    try { storedLLM = JSON.parse(localStorage.getItem('llm_settings') || 'null') } catch(e){ storedLLM = null; }
    const mergedLLM = Object.assign({}, defaultLLM, storedLLM || {});
    if(!mergedLLM.keys) mergedLLM.keys = { openrouter:'', openai:'', gemini:'', deepseek:'' };

    return {
      currentView:'settings',
      loading:false,
      loadingText:'',

      // LLM 设置
      llm: mergedLLM,

      // 分组词库
      groups: {},            // { groupName: [verbs] }
      currentGroup: '默认',
      newGroupName: '',
      newVerb:'',

      // 练习
      isPracticeActive:false,
      settings:{
        level:'A2',
        tense:'Présent',
        mode:'group',
        groupName:'默认',
        count:5
      },
      sessionCards:[],
      currentIndex:0,

      // 当前题状态
      userInput:'',
      feedback:{ status:'neutral', attempts:0, showAnswer:false },

      // 模态框
      showModal:false,
      modalVerb:'',
      modalContent:''
    }
  },
  computed:{
    groupNames(){ return Object.keys(this.groups); },
    groupVerbs(){ return this.groups[this.currentGroup] || []; },
    allVerbs(){
      const s = new Set();
      for(const g of Object.keys(this.groups)) (this.groups[g]||[]).forEach(v=>s.add(v));
      return Array.from(s);
    },
    currentCard(){
      return this.sessionCards[this.currentIndex] || { prefix:'', suffix:'', verb:'', person:'', answer:'', translation:'', tense:this.settings.tense };
    },
    activeApiKey(){
      const p = this.llm.provider;
      if(p==='openrouter' || p==='custom') return (this.llm.keys.openrouter||'').trim();
      if(p==='openai') return (this.llm.keys.openai||'').trim();
      if(p==='gemini') return (this.llm.keys.gemini||'').trim();
      if(p==='deepseek') return (this.llm.keys.deepseek||'').trim();
      return '';
    }
  },
  mounted(){
    // 兼容迁移旧版 Gemini key
    const oldGeminiKey = localStorage.getItem('gemini_api_key');
    if(oldGeminiKey && !this.llm.keys?.gemini){
      this.llm.keys = this.llm.keys || {};
      this.llm.keys.gemini = oldGeminiKey;
    }

    // 载入/迁移本地存储
    const stored = localStorage.getItem('verb_groups');
    if(stored){
      try { this.groups = JSON.parse(stored) || {}; } catch(e){ this.groups = {}; }
    }else{
      const old = JSON.parse(localStorage.getItem('verb_library') || '[]');
      this.groups = { '默认': (old.length? old : ['aimer','finir','être','avoir','aller','faire','pouvoir','savoir']) };
      this.saveGroups();
    }
    if(!this.groups[this.currentGroup]) this.currentGroup = this.groupNames[0];
    this.settings.groupName = this.currentGroup;
  },
  methods:{
    // —— 工具 ——
    saveGroups(){ localStorage.setItem('verb_groups', JSON.stringify(this.groups)); },
    stripCodeFences(str=''){ return String(str).replace(/^```[\s\S]*?\n/,'').replace(/```$/,'').trim(); },
    decodeHTMLEntities(str=''){ const ta=document.createElement('textarea'); ta.innerHTML=str; return ta.value; },

    // —— 设置 ——
    saveSettings(){
      localStorage.setItem('llm_settings', JSON.stringify(this.llm));
      alert('设置已保存');
      this.currentView = 'library';
    },

    // —— 词库管理（分组） ——
    addGroup(){
      const name = (this.newGroupName||'').trim();
      if(!name){ alert('分组名不能为空'); return; }
      if(this.groups[name]){ alert('已存在同名分组'); return; }
      this.groups[name] = [];
      this.groups = { ...this.groups };
      this.saveGroups();
      this.currentGroup = name;
      this.settings.groupName = name;
      this.newGroupName = '';
    },
    addVerb(){
      const v = (this.newVerb||'').trim();
      if(!v) return;
      const list = this.groups[this.currentGroup] || [];
      if(!list.includes(v)){
        list.push(v);
        this.groups[this.currentGroup] = list;
        this.saveGroups();
      }
      this.newVerb='';
    },
    removeVerb(idx){
      (this.groups[this.currentGroup]||[]).splice(idx,1);
      this.saveGroups();
      this.groups = { ...this.groups };
    },
    moveVerb(verb, targetGroup){
      if(!targetGroup) return;
      if(!this.groups[targetGroup]){ alert('目标分组不存在'); return; }
      const list = this.groups[this.currentGroup]||[];
      const i = list.indexOf(verb);
      if(i>-1) list.splice(i,1);
      if(!this.groups[targetGroup].includes(verb)) this.groups[targetGroup].push(verb);
      this.saveGroups();
      this.groups = { ...this.groups };
    },

    // —— Prompt 构造 ——
    buildPracticePrompt(tense, level, verbs){
      const total = verbs.length * 6;
      return `You are a strict French teacher. For EACH verb below, create EXACTLY SIX fill-in-the-blank exercises in the SINGLE tense "${tense}", one per person in:
[Je, Tu, Il/Elle/On, Nous, Vous, Ils/Elles].
Level: ${level} (CEFR).
Verbs: ${verbs.join(', ')}.

Return a RAW JSON array with EXACTLY ${total} objects (no markdown fences). Each object MUST follow:
{
  "verb": "<infinitive>",
  "tense": "${tense}",
  "person": "<Je|Tu|Il/Elle/On|Nous|Vous|Ils/Elles>",
  "answer": "<conjugated_verb_only>",
  "prefix": "<sentence_part_before_verb_including_correct_subject_and_elision>",
  "suffix": "<sentence_part_after_verb>",
  "translation": "<Chinese translation>"
}

Rules:
1) One and only one exercise per (verb, person) pair in "${tense}".
2) 'answer' is ONLY the correctly conjugated finite verb for that person and tense (no subject, no objects). 
   For compound tenses like "Passé Composé", the blank is the correctly conjugated auxiliary only; keep the past participle in prefix/suffix.
3) Put the correct subject (with elision like "J'") in 'prefix'.
4) Difficulty should match ${level}.`;
    },
    buildTablePrompt(verb){
      return `Generate a clear, formatted HTML table of the conjugation for the French verb "${verb}".
Include columns for: Présent, Passé Composé, Imparfait, Futur Simple.
Include rows for: Je, Tu, Il/Elle, Nous, Vous, Ils/Elles.
Use Tailwind CSS classes for styling (simple table). Output only the HTML table code.`;
    },

    // —— 调用多提供商 LLM ——
    async callLLM({system=null, user, stream=false}){
      const provider = this.llm.provider;
      const model = (this.llm.model||'').trim();
      const key = this.activeApiKey;
      if(!key) throw new Error('API Key 为空。');

      if(provider==='gemini'){
        const useModel = model || 'gemini-2.0-flash';
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(useModel)}:generateContent`;
        const payload = { contents: [{ role:'user', parts: [{ text: (system?(`[SYSTEM]\n${system}\n\n[USER]\n${user}`): user) }] }] };
        const resp = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'X-goog-api-key': key },
          body: JSON.stringify(payload)
        });
        const raw = await resp.text();
        if(!resp.ok) throw new Error(`API Error ${resp.status}: ${raw}`);
        let data; try{ data = JSON.parse(raw) } catch(e){ throw new Error('API 返回的不是合法 JSON：'+raw); }
        const out = data?.candidates?.[0]?.content?.parts?.[0]?.text;
        if(!out) throw new Error('API 返回结构中没有 text 字段：'+raw);
        return out;
      }

      // OpenAI / OpenRouter / DeepSeek / Custom：OpenAI 兼容 chat-completions
      let base = '';
      const headers = { 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` };
      if(provider==='openai'){
        base = 'https://api.openai.com/v1/chat/completions';
      }else if(provider==='openrouter'){
        base = 'https://openrouter.ai/api/v1/chat/completions';
      }else if(provider==='deepseek'){
        base = 'https://api.deepseek.com/v1/chat/completions';
      }else if(provider==='custom'){
        base = (this.llm.baseUrl||'').trim();
        if(!base) throw new Error('自定义 Base URL 为空');
      }

      const useModel = model || (provider==='openai' ? 'gpt-3.5-turbo' : (provider==='deepseek' ? 'deepseek-chat' : 'openai/gpt-3.5-turbo'));
      const payload = {
        model: useModel,
        messages: [
          ...(system ? [{ role:'system', content: system }] : []),
          { role:'user', content: user }
        ],
        stream: !!stream
      };

      const resp = await fetch(base, { method:'POST', headers, body: JSON.stringify(payload) });
      const raw = await resp.text();
      if(!resp.ok) throw new Error(`API Error ${resp.status}: ${raw}`);
      let data; try{ data = JSON.parse(raw); } catch(e){ throw new Error('API 返回的不是合法 JSON：'+raw); }
      const out = data?.choices?.[0]?.message?.content ?? data?.choices?.[0]?.delta?.content;
      if(!out) throw new Error('API 返回结构中没有 content 字段：'+raw);
      return out;
    },

    // —— 练习生成 —— 每个动词 × 六个人称
    async startPracticeSession(){
      if(!this.activeApiKey) return alert('请输入 API Key');

      // 选词
      let targetVerbs = [];
      if(this.settings.mode==='group'){
        const g = this.settings.groupName;
        targetVerbs = (this.groups[g] || []).slice();
        if(!targetVerbs.length){ alert('该分组暂无动词'); return; }
      }else{
        const all = this.allVerbs.slice();
        if(!all.length){ alert('词库为空'); return; }
        const n = Math.max(1, Math.min(this.settings.count || 1, all.length));
        targetVerbs = all.sort(()=>0.5-Math.random()).slice(0,n);
      }

      const persons = ['Je','Tu','Il/Elle/On','Nous','Vous','Ils/Elles'];
      const tense = this.settings.tense;
      const total = targetVerbs.length * persons.length;

      this.loading = true;
      this.loadingText = `正在生成 ${total} 道题...`;

      const prompt = this.buildPracticePrompt(tense, this.settings.level, targetVerbs);

      try{
        const result = await this.callLLM({ system: null, user: prompt });
        const clean = this.stripCodeFences(result);
        const arr = JSON.parse(clean);

        if(!Array.isArray(arr) || arr.length !== total){
          console.warn('AI 返回数量与预期不符，收到：', arr?.length, '预期：', total);
        }
        // 打乱顺序
        this.sessionCards = (arr || []).sort(()=>0.5-Math.random());
        this.isPracticeActive = true;
        this.currentIndex = 0;
        this.resetCardState();
      }catch(e){
        alert('生成失败，请检查 Key、模型或网络。\n'+ e.message);
        console.error(e);
      }finally{
        this.loading = false;
      }
    },

    // —— 变位表 ——（HTML 反转义 + 直接 v-html 渲染）
    async showConjugationTable(verb){
      this.modalVerb = verb;
      this.showModal = true;
      this.loading = true;
      this.loadingText = `正在查询 ${verb} 的变位...`;
      this.modalContent = '<p class="text-center text-gray-500">加载中...</p>';

      const prompt = this.buildTablePrompt(verb);

      try{
        const raw = await this.callLLM({ system:null, user: prompt });
        const noFence = this.stripCodeFences(raw);
        const decoded = this.decodeHTMLEntities(noFence);
        this.modalContent = decoded;
      }catch(e){
        this.modalContent = '加载失败: ' + e.message;
      }finally{
        this.loading = false;
      }
    },

    // —— 练习逻辑 ——
    resetCardState(){
      this.userInput='';
      this.feedback={ status:'neutral', attempts:0, showAnswer:false };
      this.$nextTick(()=>{ if(this.$refs.answerInput) this.$refs.answerInput.focus(); });
    },
    checkAnswer(){
      if(this.feedback.status==='correct') return;
      const correct = (this.currentCard.answer || '').trim();
      const input = this.userInput.trim();
      if(!correct) return;

      if(input === correct){
        this.feedback.status='correct';
        setTimeout(this.nextCard,1200);
      }else{
        this.feedback.status='wrong';
        this.feedback.attempts++;
        if(this.feedback.attempts>=3) this.feedback.showAnswer=true;
      }
    },
    nextCard(){
      if(this.currentIndex < this.sessionCards.length - 1){
        this.currentIndex++;
        this.resetCardState();
      }else{
        alert('练习完成！');
        this.isPracticeActive=false;
      }
    },
    endPractice(){
      if(confirm('确定退出当前练习吗？')){
        this.isPracticeActive=false;
        this.userInput='';
        this.feedback={ status:'neutral', attempts:0, showAnswer:false };
      }
    }
  }
}).mount('#app');
</script>
</body>
</html>
