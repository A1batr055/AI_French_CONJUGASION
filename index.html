<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI 法语变位大师 · 多模型</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.5.12/dist/vue.global.prod.js"></script>
  <script src="https://kit.fontawesome.com/a2e0e9b6d8.js" crossorigin="anonymous"></script>
  <style>
    :root{ --ink:#0b1220; --bd:#e5e7eb; --brand:#10b981; --muted:#667085; }
    *{ box-sizing:border-box } html,body{height:100%}
    body{ margin:0; background:#f5f7fb; color:var(--ink); font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial }
    .container{ max-width:1100px; margin:0 auto; padding:16px }
    header{ display:flex; justify-content:space-between; gap:8px; margin-bottom:12px }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap }
    .tab{ padding:8px 12px; border:1px solid var(--bd); background:#fff; border-radius:10px; cursor:pointer }
    .tab[aria-selected="true"]{ background:#eef2ff; border-color:#c7d2fe }
    .card{ background:#fff; border:1px solid var(--bd); border-radius:16px; padding:16px; margin:12px 0 }
    .row{ display:flex; gap:12px; flex-wrap:wrap } .col{ flex:1 1 320px; min-width:280px }
    label{ display:block; margin:10px 0 6px; color:#64748b; font-size:12px }
    input,select,textarea,button{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--bd); background:#fff; color:var(--ink) }
    textarea{ min-height:120px; resize:vertical }
    button.primary{ background:var(--brand); color:#fff; border:none; cursor:pointer }
    .muted{ color:#94a3b8; font-size:12px } .divider{height:1px;background:#eef2f7;margin:12px 0}
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#10151f; color:#fff; padding:10px 14px; border-radius:10px; border:1px solid #2b3345; z-index:9999 }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <header>
        <div><strong>AI 法语变位大师</strong></div>
        <nav class="tabs" role="tablist" aria-label="pages">
          <button class="tab" role="tab" :aria-selected="currentView==='settings'" @click="switchView('settings')">设置</button>
          <button class="tab" role="tab" :aria-selected="currentView==='verbs'" @click="switchView('verbs')">词库</button>
          <button class="tab" role="tab" :aria-selected="currentView==='practice'" @click="switchView('practice')">练习</button>
        </nav>
      </header>

      <section v-show="currentView==='settings'" class="card">
        <h3 style="margin:0 0 8px 0">模型与密钥</h3>
        <div class="row">
          <div class="col">
            <label>调用方式</label>
            <select v-model="llm.provider">
              <option value="openrouter">OpenRouter（推荐）</option>
              <option value="openai">OpenAI（直连）</option>
              <option value="gemini">Google Gemini（直连）</option>
              <option value="deepseek">DeepSeek（直连）</option>
              <option value="custom">自定义（OpenAI 协议兼容）</option>
            </select>
            <div class="muted" style="margin-top:6px">默认使用 OpenRouter 免费模型；其它直连需自备可用 Key 与模型 ID。</div>
          </div>

          <div class="col" v-show="llm.provider==='openrouter'">
            <label>免费模型（自动同步，稳定精选）</label>
            <select v-model="modelChoice">
              <option v-for="m in orModelsToShow" :key="'or-'+m.id" :value="m.id">{{ m.label }}</option>
            </select>
            <div class="muted" style="margin-top:6px">
              新账号合计约 <b>50 次/天</b>；如购买 ≥10 credits，免费模型升至 <b>1000 次/天</b>。
            </div>
          </div>

          <div class="col" v-show="llm.provider!=='openrouter'">
            <label>自填模型 ID</label>
            <input v-model="llm.model" placeholder="例如：gpt-4o-mini / gemini-2.0-flash / deepseek-chat">
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>API Key</label>
            <input v-model="llm.keys[llm.provider]" placeholder="在此粘贴你的 API Key（本地保存）" autocomplete="off">
            <div class="muted" style="margin-top:6px">
              OpenRouter Key：<a href="https://openrouter.ai/keys" target="_blank" rel="noopener">https://openrouter.ai/keys</a>
            </div>
          </div>
          <div class="col">
            <label>高级选项</label>
            <div class="row">
              <div class="col">
                <input type="number" step="0.1" min="0" max="2" v-model.number="llm.temperature">
                <div class="muted">temperature（0–2）</div>
              </div>
              <div class="col">
                <input type="number" min="1" max="8192" v-model.number="llm.max_tokens">
                <div class="muted">max_tokens</div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <div class="col"><button class="primary" @click="saveSettings">保存设置</button></div>
          <div class="col"><button @click="resetSettings">清空本地设置</button></div>
        </div>
      </section>

      <section v-show="currentView==='verbs'" class="card">
        <h3 style="margin:0 0 8px 0">词库</h3>
        <div class="row">
          <div class="col">
            <label>添加动词（逗号分隔）</label>
            <textarea v-model="newVerb" placeholder="venir, aller, être, avoir"></textarea>
            <div class="row" style="margin-top:6px">
              <div class="col"><button class="primary" @click="addVerb">添加到词库</button></div>
              <div class="col"><button @click="clearVerbs">清空词库</button></div>
              <div class="col"><button class="primary" @click="switchView('practice')">开始练习 →</button></div>
            </div>
          </div>
          <div class="col">
            <label>当前词库</label>
            <textarea :value="allVerbs.join(', ')" readonly></textarea>
          </div>
        </div>
      </section>

      <section v-show="currentView==='practice'" class="card">
        <h3 style="margin:0 0 8px 0">练习</h3>
        <div class="row">
          <div class="col">
            <label>生成题目提示词（可改）</label>
            <textarea v-model="promptTpl">请用法语为以下动词各生成 6 道人称变位填空题（Je, Tu, Il/Elle/On, Nous, Vous, Ils/Elles），并给出答案与简要讲解。动词列表：{{verbs}}</textarea>
          </div>
          <div class="col">
            <label>操作</label>
            <button id="gen" class="primary" @click="startPracticeSession">
              {{ activeApiKey ? '生成题目（调用 AI）' : '生成题目（将提示填写 Key）' }}
            </button>
            <div class="muted" style="margin-top:6px">若 404/429，请在“设置”更换模型；或等 1–2 分钟再试。</div>
          </div>
        </div>
        <div class="divider"></div>
        <label>输出</label>
        <textarea id="out" readonly style="min-height:240px">{{ lastOutput }}</textarea>
      </section>
    </div>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

  <script>
  // —— 防止 localStorage 坏 JSON 直接把页面搞崩 ——
  function safeGetJSON(key, fallback){
    try{
      const v = localStorage.getItem(key);
      if(!v) return fallback;
      return JSON.parse(v);
    }catch(e){
      console.warn('损坏的本地数据，已清除：', key);
      try{ localStorage.removeItem(key); }catch{}
      return fallback;
    }
  }

  const { createApp } = Vue;

  createApp({
    data(){
      const curatedOrFree = [
        { id: 'openai/gpt-oss-20b:free',                label: 'OpenAI · GPT-OSS-20B（free）' },
        { id: 'meta-llama/llama-3.3-70b-instruct:free', label: 'Meta · Llama-3.3-70B-Instruct（free）' },
        { id: 'amazon/nova-2-lite-v1:free',             label: 'Amazon · Nova-2-Lite-v1（free）' },
        { id: 'google/gemini-2.0-flash-exp:free',       label: 'Google · Gemini 2.0 Flash Exp（free，非默认）' }
      ];
      const defaultLLM = {
        provider:'openrouter',
        model:'openai/gpt-oss-20b:free',
        baseUrl:'',
        temperature:0.2,
        max_tokens:512,
        keys:{ openrouter:'', openai:'', gemini:'', deepseek:'', custom:'' }
      };
      return {
        currentView:'settings',
        llm: safeGetJSON('llm_settings', defaultLLM),
        curatedOrFree,
        orUserFree:[], modelChoice:'openai/gpt-oss-20b:free',
        groups: safeGetJSON('verb_groups', { '默认':['parler','finir','être','avoir','aller','faire','pouvoir','savoir'] }),
        currentGroup:'默认',
        newVerb:'',
        promptTpl:'请用法语为以下动词各生成 6 道人称变位填空题（Je, Tu, Il/Elle/On, Nous, Vous, Ils/Elles），并给出答案与简要讲解。动词列表：{{verbs}}',
        lastOutput:'',
        err:{ show:false, msg:'' }
      }
    },
    computed:{
      orModelsToShow(){
        if(this.orUserFree.length){
          const allow = new Set(this.curatedOrFree.map(m=>m.id));
          return this.orUserFree.filter(m => allow.has(m.id));
        }
        return this.curatedOrFree;
      },
      allVerbs(){ return Array.from(new Set(Object.values(this.groups).flat())); },
      activeApiKey(){
        const p=this.llm.provider;
        return (this.llm.keys && this.llm.keys[p]) ? this.llm.keys[p].trim() : '';
      }
    },
    mounted(){
      this.modelChoice = this.llm.model || 'openai/gpt-oss-20b:free';
      if(this.llm.provider==='openrouter' && (this.llm.keys.openrouter||'').trim()){
        this.tryLoadOrUserModels();
      }
    },
    methods:{
      switchView(v){ this.currentView=v; },
      toast(s){
        const t=document.getElementById('toast');
        t.textContent=s; t.style.display='block';
        clearTimeout(this._t); this._t=setTimeout(()=>t.style.display='none',2200);
      },
      showError(msg){ alert(msg); },

      saveSettings(){
        this.llm.model = this.modelChoice || this.llm.model || 'openai/gpt-oss-20b:free';
        localStorage.setItem('llm_settings', JSON.stringify(this.llm));
        this.toast('设置已保存');
      },
      resetSettings(){
        localStorage.removeItem('llm_settings');
        this.toast('已清空本地设置'); setTimeout(()=>location.reload(),300);
      },

      addVerb(){
        const raw=(this.newVerb||'').trim(); if(!raw) return this.toast('请输入动词');
        const add=raw.split(',').map(s=>s.trim()).filter(Boolean);
        const g=this.groups[this.currentGroup]||[];
        this.groups[this.currentGroup]=Array.from(new Set([...g,...add]));
        this.newVerb='';
        localStorage.setItem('verb_groups', JSON.stringify(this.groups));
        this.toast('已添加到词库');
      },
      clearVerbs(){
        if(confirm('确定清空当前所有分组内的动词吗？')){
          this.groups={ '默认':[] }; this.currentGroup='默认';
          localStorage.setItem('verb_groups', JSON.stringify(this.groups));
          this.toast('已清空');
        }
      },

      async tryLoadOrUserModels(){
        try{
          const r = await fetch('https://openrouter.ai/api/v1/models/user',{
            headers:{ 'Authorization':'Bearer '+(this.llm.keys.openrouter||'') }
          });
          if(!r.ok) throw new Error('HTTP '+r.status);
          const data=await r.json();
          const items=(data.data||[]).filter(x=>x.id && x.id.endsWith(':free'));
          this.orUserFree = items.map(x=>({ id:x.id, label:x.id }));
          if(!items.some(x=>x.id===this.modelChoice)){
            this.modelChoice='openai/gpt-oss-20b:free';
          }
        }catch(e){
          console.warn('OpenRouter /user 拉取失败：',e);
          this.orUserFree=[];
        }
      },

      friendlyError(status, body=''){
        const low=(body||'').toLowerCase();
        if(status===401 || low.includes('unauthorized')||low.includes('invalid api')) return 'API Key 无效或未授权（401）。';
        if(status===404 && (low.includes('model')||low.includes('not found'))) return '模型不存在/已下线（404）。';
        if(status===429 || low.includes('rate')||low.includes('quota')||low.includes('exceed')) return '限流/额度不足（429/Quota）。';
        if(status===400 || low.includes('bad request')) return '请求参数不合法（400）。';
        return `调用失败（HTTP ${status||'未知'}）。`;
      },

      async callLLM({system=null, user}){
        const provider=this.llm.provider;
        const key=this.activeApiKey;
        if(!key) throw new Error('API Key 为空。');

        if(provider==='gemini'){
          const model=(this.llm.model||'gemini-2.0-flash').trim();
          const url=`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:generateContent?key=${encodeURIComponent(key)}`;
          const resp=await fetch(url,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ contents:[{parts:[{text:(system?('[SYSTEM] '+system+'\n\n'):'')+user}]}] }) });
          const raw=await resp.text();
          if(!resp.ok) throw new Error(this.friendlyError(resp.status, raw));
          const data=JSON.parse(raw);
          const txt=(data?.candidates?.[0]?.content?.parts||[]).map(p=>p.text).join('')||'';
          if(!txt) throw new Error('模型无返回文本。');
          return txt;
        }

        let base=''; const headers={ 'Content-Type':'application/json', 'Authorization':'Bearer '+key };
        if(provider==='openai') base='https://api.openai.com/v1/chat/completions';
        else if(provider==='openrouter') base='https://openrouter.ai/api/v1/chat/completions';
        else if(provider==='deepseek') base='https://api.deepseek.com/v1/chat/completions';
        else if(provider==='custom'){
          base=(this.llm.baseUrl||'').trim();
          if(!base) throw new Error('自定义 Base URL 为空');
        }

        const model = (this.llm.model||'').trim() || (provider==='openai' ? 'gpt-3.5-turbo' : (provider==='deepseek' ? 'deepseek-chat' : 'openai/gpt-3.5-turbo'));
        const payload={ model, messages:[ ...(system?[{role:'system',content:system}]:[]), {role:'user',content:user}], max_tokens:this.llm.max_tokens||512, temperature:this.llm.temperature ?? 0.2 };

        let resp = await fetch(base,{ method:'POST', headers, body:JSON.stringify(payload) });
        let raw  = await resp.text();
        if(!resp.ok){
          if(provider==='openrouter' && resp.status===404 && payload.model!=='openai/gpt-oss-20b:free'){
            this.llm.model   = 'openai/gpt-oss-20b:free';
            this.modelChoice = 'openai/gpt-oss-20b:free';
            const fallbackPayload={ ...payload, model:'openai/gpt-oss-20b:free' };
            resp = await fetch(base,{ method:'POST', headers, body:JSON.stringify(fallbackPayload) });
            raw  = await resp.text();
            if(!resp.ok) throw new Error(this.friendlyError(resp.status, raw));
          }else{
            throw new Error(this.friendlyError(resp.status, raw));
          }
        }

        let data; try{ data=JSON.parse(raw) }catch{ throw new Error('服务端返回非 JSON。') }
        if(data?.error) throw new Error(this.friendlyError(resp.status, data.error?.message||''));
        const out=data?.choices?.[0]?.message?.content || '';
        if(!out) throw new Error('模型无返回文本。');
        return out;
      },

      async startPracticeSession(){
        if(!this.activeApiKey) return alert('请输入 API Key');

        const verbs=(this.groups['默认']||[]).slice();
        if(!verbs.length) return alert('词库为空，请先添加动词');

        const picked=verbs.slice(0,5);
        const prompt=this.promptTpl.replace('{{verbs}}', picked.join(', '));

        this.lastOutput='生成中…';
        try{
          const text=await this.callLLM({ system:'你是专业法语教师，擅长构造简洁、分步、带答案与讲解的变位练习。', user:prompt });
          this.lastOutput = text;
        }catch(e){
          console.error(e);
          alert(e.message||'调用失败');
          this.lastOutput='';
        }
      },
    }
  }).mount('#app');
  </script>
</body>
</html>
