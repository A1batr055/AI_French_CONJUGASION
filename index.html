<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>AI 法语变位练习 · 多模型</title>
  <style>
    :root{--bg:#0b0d10;--card:#151922;--ink:#e8ecf1;--sub:#a9b3c1;--accent:#69b7ff;--ok:#3cc86a;--warn:#ffb347;--err:#ff6b6b;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    header{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid #2a3242;border-radius:8px;background:#0f1218;cursor:pointer}
    .tab[aria-selected="true"]{background:var(--card);border-color:#3a4358}
    .card{background:var(--card);border:1px solid #2a3242;border-radius:12px;padding:16px;margin:12px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px;min-width:260px}
    label{display:block;margin:10px 0 6px;color:var(--sub)}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3242;background:#0f1218;color:var(--ink)}
    textarea{min-height:120px;resize:vertical}
    button.primary{background:var(--accent);color:#00182a;border:none;cursor:pointer}
    button.ghost{background:#0f1218;color:var(--ink)}
    .muted{color:var(--sub);font-size:12px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3242;margin-left:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .flex{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#10151f;border:1px solid #2a3242;color:var(--ink);padding:10px 14px;border-radius:10px;max-width:92%;z-index:9999}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#111826;border:1px solid #2a3242;border-radius:6px;padding:0 6px}
    .divider{height:1px;background:#222a39;margin:12px 0}
    .right{float:right}
    /* Mobile fix: avoid focus auto-scroll bounce */
    input,select,textarea{touch-action:manipulation}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="font-weight:600">AI 法语变位大师（Gemini / ChatGPT / DeepSeek / OpenRouter）</div>
      <nav class="tabs" role="tablist" aria-label="pages">
        <button class="tab" role="tab" data-page="settings" aria-selected="true">设置</button>
        <button class="tab" role="tab" data-page="verbs">词库</button>
        <button class="tab" role="tab" data-page="practice">练习</button>
      </nav>
    </header>

    <!-- Settings -->
    <section id="page-settings" class="card">
      <h3 style="margin:0 0 8px 0">模型与密钥</h3>
      <div class="row">
        <div class="col">
          <label for="provider">调用方式</label>
          <select id="provider">
            <option value="openrouter">OpenRouter（推荐，支持多家免费模型）</option>
            <option value="custom">自定义（OpenAI / Google / DeepSeek / 其他）</option>
          </select>
        </div>
        <div class="col" id="openrouter-model-col">
          <label for="or-model">免费模型（当前可用）</label>
          <select id="or-model">
            <!-- 注意：默认不是 Gemini -->
            <option value="openai/gpt-oss-20b:free">OpenAI — gpt-oss-20b:free</option>
            <option value="amazon/nova-2-lite-v1:free">Amazon — nova-2-lite-v1:free</option>
            <option value="meta-llama/llama-3.3-70b-instruct:free">Meta — llama-3.3-70b-instruct:free</option>
            <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek — deepseek-chat-v3.1:free</option>
            <option value="mistralai/mistral-7b-instruct:free">Mistral — mistral-7b-instruct:free</option>
            <option value="google/gemini-2.0-flash-exp:free">Google — gemini-2.0-flash-exp:free（限流）</option>
          </select>
          <div class="muted" style="margin-top:6px">
            免费额度：新用户合计每日约 <b>50 次</b>；若购买 ≥10 credits，免费模型额度升至 <b>1000 次/天</b>。
            <a href="https://openrouter.ai/docs/faq" target="_blank" rel="noopener">查看 FAQ</a>
          </div>
        </div>
        <div class="col hidden" id="custom-provider-col">
          <label for="custom-provider">自定义供应商</label>
          <select id="custom-provider">
            <option value="openai">OpenAI（ChatGPT 兼容）</option>
            <option value="google">Google Gemini</option>
            <option value="deepseek">DeepSeek</option>
            <option value="openrouter-custom">OpenRouter（自填模型 ID）</option>
          </select>
        </div>
        <div class="col hidden" id="custom-model-col">
          <label for="custom-model">模型 ID</label>
          <input id="custom-model" placeholder="例如：gpt-4o-mini / gemini-2.0-flash / deepseek-chat"/>
          <div class="muted">提示：不同厂商的模型 ID 写法不同，请按各自文档填写。</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="api-key">API Key</label>
          <input id="api-key" placeholder="在此粘贴你的 API Key（本地保存，不会上传）" autocomplete="off" />
          <div class="muted" style="margin-top:6px">
            OpenRouter 获取密钥：
            <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">https://openrouter.ai/keys</a>
            （需科学上网）
          </div>
        </div>
        <div class="col">
          <label>高级选项</label>
          <div class="row">
            <div class="col">
              <input id="temperature" type="number" step="0.1" min="0" max="2" value="0.3" />
              <div class="muted">temperature（0–2）</div>
            </div>
            <div class="col">
              <input id="max-tokens" type="number" min="1" max="8192" value="512" />
              <div class="muted">max_tokens</div>
            </div>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div class="col">
          <button class="primary" id="save">保存设置</button>
        </div>
        <div class="col">
          <button class="ghost" id="reset">清空本地设置</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <b>关于 OpenRouter（简版说明）</b>
        <ul style="margin:8px 0 0 16px;padding:0">
          <li>用一个 API 统一调用多家模型；本页默认只列出当前可用的“免费”变体。</li>
          <li>免费模型合并共享每日配额（默认 50 次/天；充值≥10 credits 升至 1000 次/天）。遇到 429，是额度或限流，请稍后或换模型。详情见
            <a href="https://openrouter.ai/docs/faq" target="_blank" rel="noopener">FAQ</a>。</li>
          <li>Gemini 的 <code>gemini-2.0-flash-exp:free</code> 官方标注“强限流”，不作为默认。</li>
        </ul>
      </div>
    </section>

    <!-- Verbs -->
    <section id="page-verbs" class="card hidden">
      <h3 style="margin:0 0 8px 0">词库</h3>
      <div class="row">
        <div class="col">
          <label for="verb-input">添加动词（逗号分隔）</label>
          <textarea id="verb-input" placeholder="venir, aller, être, avoir"></textarea>
          <div class="row">
            <div class="col"><button id="add-verbs" class="primary">添加到词库</button></div>
            <div class="col"><button id="clear-verbs" class="ghost">清空词库</button></div>
            <div class="col"><button id="go-practice" class="primary">开始练习 →</button></div>
          </div>
        </div>
        <div class="col">
          <label>当前词库</label>
          <textarea id="verb-store" readonly></textarea>
          <div class="muted">数据保存在浏览器的 <span class="kbd">localStorage</span>（键：<span class="kbd">verb_groups</span>）。</div>
        </div>
      </div>
    </section>

    <!-- Practice -->
    <section id="page-practice" class="card hidden">
      <h3 style="margin:0 0 8px 0">练习（示例）</h3>
      <div class="row">
        <div class="col">
          <label for="prompt">让模型出题（示例提示词，可自行修改）</label>
          <textarea id="prompt">请用法语为以下动词各生成 6 道人称变位填空题（Je, Tu, Il/Elle/On, Nous, Vous, Ils/Elles），并给出答案与简要讲解。动词列表：{{verbs}}</textarea>
        </div>
        <div class="col">
          <label>操作</label>
          <button id="gen" class="primary">生成练习</button>
          <div class="muted" style="margin-top:6px">若 404/429，请在“设置”更换模型；或等 1–2 分钟再试。</div>
        </div>
      </div>
      <div class="divider"></div>
      <label>输出</label>
      <textarea id="out" readonly style="min-height:240px"></textarea>
    </section>
  </div>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <script>
    // ========= Storage =========
    const LS_KEY_SETTINGS = 'llm_settings';
    const LS_KEY_VERBS = 'verb_groups'; // 兼容你之前的命名
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    function toast(msg, cls=''){ const t=$('#toast'); t.textContent=msg; t.className='toast'+(cls?(' '+cls):''); t.classList.remove('hidden'); setTimeout(()=>t.classList.add('hidden'), 2800); }

    // ========= Tabs =========
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.tab').forEach(b=>b.setAttribute('aria-selected','false'));
        btn.setAttribute('aria-selected','true');
        const page=btn.dataset.page;
        ['settings','verbs','practice'].forEach(id=>$('#page-'+id).classList.toggle('hidden', id!==page));
      });
    });

    // ========= Models (curated free list) =========
    const FREE_MODELS = [
      { id:'openai/gpt-oss-20b:free', label:'OpenAI — gpt-oss-20b:free' },
      { id:'amazon/nova-2-lite-v1:free', label:'Amazon — nova-2-lite-v1:free' },
      { id:'meta-llama/llama-3.3-70b-instruct:free', label:'Meta — llama-3.3-70b-instruct:free' },
      { id:'deepseek/deepseek-chat-v3.1:free', label:'DeepSeek — deepseek-chat-v3.1:free' },
      { id:'mistralai/mistral-7b-instruct:free', label:'Mistral — mistral-7b-instruct:free' },
      { id:'google/gemini-2.0-flash-exp:free', label:'Google — gemini-2.0-flash-exp:free（限流）' },
    ];

    // ========= UI bindings =========
    const els = {
      provider: $('#provider'),
      orModel: $('#or-model'),
      customProviderCol: $('#custom-provider-col'),
      customModelCol: $('#custom-model-col'),
      customProvider: $('#custom-provider'),
      customModel: $('#custom-model'),
      apiKey: $('#api-key'),
      temp: $('#temperature'),
      maxTokens: $('#max-tokens'),
      verbInput: $('#verb-input'),
      verbStore: $('#verb-store'),
      out: $('#out'),
      prompt: $('#prompt'),
    };

    // provider switch
    els.provider.addEventListener('change', ()=>{
      const useOR = els.provider.value==='openrouter';
      $('#openrouter-model-col').classList.toggle('hidden', !useOR);
      els.customProviderCol.classList.toggle('hidden', useOR);
      els.customModelCol.classList.toggle('hidden', useOR);
    });

    // load settings
    function loadSettings(){
      try{
        const s = JSON.parse(localStorage.getItem(LS_KEY_SETTINGS)||'{}');
        if(s.provider) els.provider.value = s.provider;
        if(s.model) els.orModel.value = s.model;
        if(s.customProvider) els.customProvider.value = s.customProvider;
        if(s.customModel) els.customModel.value = s.customModel;
        if(s.apiKey) els.apiKey.value = s.apiKey;
        if(s.temperature!=null) els.temp.value = s.temperature;
        if(s.max_tokens!=null) els.maxTokens.value = s.max_tokens;
        // toggle
        els.provider.dispatchEvent(new Event('change'));
      }catch(e){}
    }
    loadSettings();

    // save settings
    $('#save').addEventListener('click', ()=>{
      const settings = {
        provider: els.provider.value,
        model: els.orModel.value,
        customProvider: els.customProvider.value,
        customModel: els.customModel.value.trim(),
        apiKey: els.apiKey.value.trim(),
        temperature: parseFloat(els.temp.value)||0.3,
        max_tokens: parseInt(els.maxTokens.value)||512,
      };
      localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify(settings));
      toast('设置已保存', 'ok');
    });

    // reset
    $('#reset').addEventListener('click', ()=>{
      localStorage.removeItem(LS_KEY_SETTINGS);
      toast('已清空本地设置','warn');
      setTimeout(()=>location.reload(), 400);
    });

    // verbs
    function refreshVerbStore(){
      const arr = JSON.parse(localStorage.getItem(LS_KEY_VERBS)||'[]');
      els.verbStore.value = arr.join(', ');
    }
    refreshVerbStore();

    $('#add-verbs').addEventListener('click', ()=>{
      const raw = els.verbInput.value.trim();
      if(!raw){ toast('请输入动词'); return; }
      const add = raw.split(',').map(s=>s.trim()).filter(Boolean);
      const old = JSON.parse(localStorage.getItem(LS_KEY_VERBS)||'[]');
      const merged = Array.from(new Set([...old, ...add]));
      localStorage.setItem(LS_KEY_VERBS, JSON.stringify(merged));
      els.verbInput.value='';
      refreshVerbStore();
      toast('已添加到词库','ok');
    });
    $('#clear-verbs').addEventListener('click', ()=>{
      localStorage.removeItem(LS_KEY_VERBS);
      refreshVerbStore();
      toast('词库已清空','warn');
    });
    $('#go-practice').addEventListener('click', ()=>{
      document.querySelector('[data-page="practice"]').click();
    });

    // ========= LLM call helpers =========
    function getSettings(){
      const s = JSON.parse(localStorage.getItem(LS_KEY_SETTINGS)||'{}');
      return {
        provider: s.provider || 'openrouter',
        model: (s.provider==='openrouter' ? (s.model || 'openai/gpt-oss-20b:free') : (s.customModel || '')),
        customProvider: s.customProvider || 'openai',
        apiKey: s.apiKey || '',
        temperature: s.temperature ?? 0.3,
        max_tokens: s.max_tokens ?? 512,
      };
    }

    async function callModel(messages){
      const s = getSettings();
      if(!s.apiKey){ throw new Error('缺少 API Key'); }

      // OpenRouter（推荐）
      if(s.provider==='openrouter' || s.customProvider==='openrouter-custom'){
        const model = s.provider==='openrouter' ? s.model : s.model; // 自定义时同字段
        try{
          const r = await fetch('https://openrouter.ai/api/v1/chat/completions',{
            method:'POST',
            headers:{
              'Authorization':'Bearer '+s.apiKey,
              'Content-Type':'application/json'
            },
            body: JSON.stringify({
              model,
              messages,
              temperature:s.temperature,
              max_tokens:s.max_tokens,
              stream:false
            })
          });
          if(!r.ok){
            const text = await r.text();
            // 404 自动尝试回退
            if(r.status===404 && model!=='openai/gpt-oss-20b:free'){
              toast('当前模型不可用，已尝试回退到 gpt-oss-20b:free','warn');
              localStorage.setItem(LS_KEY_SETTINGS, JSON.stringify({...JSON.parse(localStorage.getItem(LS_KEY_SETTINGS)||'{}'), model:'openai/gpt-oss-20b:free'}));
              return await callModel(messages);
            }
            // 429/额度
            if(r.status===429){
              throw new Error('429 限流/额度不足：更换模型或稍后再试。');
            }
            throw new Error(`HTTP ${r.status}：${text.slice(0,400)}`);
          }
          const data = await r.json();
          return data?.choices?.[0]?.message?.content || JSON.stringify(data);
        }catch(e){
          throw e;
        }
      }

      // 其他直连（简单兼容：OpenAI / DeepSeek 使用 OpenAI Chat Completions 规范；Google Gemini 直连未在此示例中启用）
      if(s.customProvider==='openai' || s.customProvider==='deepseek'){
        const endpoint = s.customProvider==='openai'
          ? 'https://api.openai.com/v1/chat/completions'
          : 'https://api.deepseek.com/v1/chat/completions';
        const r = await fetch(endpoint,{
          method:'POST',
          headers:{
            'Authorization':'Bearer '+s.apiKey,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({
            model: s.model,
            messages,
            temperature:s.temperature,
            max_tokens:s.max_tokens
          })
        });
        if(!r.ok){
          const text = await r.text();
          throw new Error(`HTTP ${r.status}：${text.slice(0,400)}`);
        }
        const data = await r.json();
        return data?.choices?.[0]?.message?.content || JSON.stringify(data);
      }

      throw new Error('未支持的供应商设置');
    }

    // ========= Generate =========
    $('#gen').addEventListener('click', async ()=>{
      const verbs = JSON.parse(localStorage.getItem(LS_KEY_VERBS)||'[]');
      if(verbs.length===0){ toast('词库为空，请先添加动词'); return; }
      const prompt = $('#prompt').value.replace('{{verbs}}', verbs.join(', '));
      els.out.value = '生成中…';
      try{
        const content = await callModel([
          {role:'system', content:'你是专业法语教师，擅长构造简洁、分步、带答案与讲解的变位练习。'},
          {role:'user', content: prompt}
        ]);
        els.out.value = content;
      }catch(e){
        els.out.value = '';
        toast(String(e.message||e), 'err');
      }
    });
  </script>
</body>
</html>
